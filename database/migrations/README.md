# 数据库迁移管理

本目录包含数据库迁移脚本和管理工具。

## 文件结构

```
migrations/
├── migrate.py                              # 迁移管理器脚本
├── 000_create_migration_table.sql          # 迁移状态跟踪表
├── 001_add_publish_type_support.sql        # 添加发布方式支持
├── 002_add_auto_publish_config_publish_type.sql  # 自动发布配置发布方式
├── 003_remove_topics_publish_type.sql      # 移除话题表发布方式
└── README.md                               # 本文件
```

## 迁移管理器使用

### 1. 查看迁移状态

```bash
cd database/migrations
python migrate.py status
```

### 2. 执行待迁移脚本

```bash
python migrate.py migrate
```

### 3. 回滚迁移（暂未实现）

```bash
python migrate.py rollback --target 001
```

## 迁移脚本规范

### 文件命名

- 格式：`{版本号}__{迁移名称}.sql`
- 版本号：3位数字，从001开始
- 示例：`001_add_publish_type_support.sql`

### 脚本结构

每个迁移脚本包含：

1. **文件头注释**：描述迁移目的、影响的表、依赖关系
2. **前置检查**：验证前置条件
3. **执行迁移（UP）**：实际的数据库变更
4. **数据迁移**：如果需要数据转换
5. **验证结果**：检查迁移是否成功
6. **回滚脚本（DOWN）**：撤销迁移的SQL（注释形式）

### 示例结构

```sql
-- 迁移脚本: 001_example_migration
-- 创建时间: 2024-09-11
-- 描述: 示例迁移说明
-- 影响表: table1, table2

-- ===============================================
-- 前置检查
-- ===============================================

-- ===============================================
-- 执行迁移 - UP
-- ===============================================

-- ===============================================
-- 数据迁移（如果需要）
-- ===============================================

-- ===============================================
-- 验证迁移结果
-- ===============================================

-- ===============================================
-- 回滚脚本 - DOWN（用于撤销迁移）
-- ===============================================

/*
回滚SQL语句
*/
```

## 迁移历史

### 发布方式功能演进

1. **001_add_publish_type_support** (2024-09-11)
   - 为话题表和定时发布表添加发布方式字段
   - 支持匿名发布和实名发布功能

2. **002_add_auto_publish_config_publish_type** (2024-09-11)
   - 为自动发布配置表添加发布方式字段
   - 添加提示词键名字段

3. **003_remove_topics_publish_type** (2024-09-11)
   - 从话题表移除发布方式字段
   - 架构调整：发布方式仅在配置层级管理

## 最佳实践

1. **迁移前备份**：执行迁移前备份重要数据
2. **渐进式迁移**：避免一次性大幅度变更
3. **可回滚**：每个迁移都应提供回滚方案
4. **测试验证**：在测试环境验证迁移脚本
5. **文档记录**：详细记录迁移的目的和影响

## 故障排除

### 迁移失败

1. 查看详细错误日志
2. 检查数据库连接状态
3. 验证前置条件是否满足
4. 必要时手动回滚

### 状态不一致

1. 检查 `schema_migrations` 表记录
2. 比对实际表结构
3. 手动修正状态记录

## 注意事项

- 迁移管理器会自动跟踪迁移状态
- 不要手动修改已执行的迁移文件
- 生产环境迁移前请充分测试
- 大型迁移建议在维护窗口期执行